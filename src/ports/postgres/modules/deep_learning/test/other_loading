# MOVE
-- Tests with text class values:
-- Modify input data to have text classes, and mini-batch it.
DROP TABLE IF EXISTS cifar_10_sample_text_batched;
-- Create a new table using the text based column for dep var.
CREATE TABLE cifar_10_sample_text_batched AS
    SELECT buffer_id, independent_var, dependent_var_text_with_null AS dependent_var
    FROM cifar_10_sample_batched;
-- Insert a new row with NULL as the dependent var (one-hot encoded)
INSERT INTO cifar_10_sample_text_batched(buffer_id, independent_var, dependent_var)
    SELECT 2, independent_var, ARRAY[[0,1,0,0,0]]
    FROM cifar_10_sample_batched
    WHERE cifar_10_sample_batched.buffer_id=0;
-- Create the necessary summary table for the batched input.
DROP TABLE IF EXISTS cifar_10_sample_text_batched_summary;
CREATE TABLE cifar_10_sample_text_batched_summary(
    source_table text,
    output_table text,
    dependent_varname text,
    independent_varname text,
    dependent_vartype text,
    class_values text[],
    buffer_size integer,
    normalizing_const numeric);
INSERT INTO cifar_10_sample_text_batched_summary values (
    'cifar_10_sample',
    'cifar_10_sample_text_batched',
    'y_text',
    'x',
    'text',
    ARRAY[NULL,'cat','dog',NULL,NULL],
    1,
    255.0);


# MOVE
DROP TABLE IF EXISTS cifar_10_sample_int_batched;
DROP TABLE IF EXISTS cifar_10_sample_int_batched_summary;
SELECT training_preprocessor_dl('cifar_10_sample','cifar_10_sample_int_batched','y','x', 2, 255, 5);

# MOVE
-- Test case with a different input shape (3, 32, 32) instead of (32, 32, 3).
-- Create a new table with image shape 3, 32, 32
drop table if exists cifar_10_sample_test_shape;
create table cifar_10_sample_test_shape(id INTEGER, y SMALLINT, x  REAL[] );
copy cifar_10_sample_test_shape from stdin delimiter '|';
1|0|{{{248,248,250,245,245,246,245,245,247,245,245,247,245,245,247,245,245,247,245,245,247,245,245,247,245,245,247,245,245,247,245,245},{247,245,245,247,245,245,247,245,245,247,245,245,247,245,245,247,245,245,247,245,245,247,245,245,247,245,245,247,245,245,247,245},{245,247,245,245,247,245,245,247,245,245,247,245,245,247,245,245,247,245,245,247,245,245,247,245,245,247,245,245,247,245,245,247},{248,248,250,245,245,247,245,245,247,245,245,247,245,245,247,245,245,247,245,245,247,245,245,247,245,245,247,245,245,247,245,245},{247,245,245,247,245,245,247,245,245,247,245,245,247,245,245,247,245,245,247,245,245,247,245,245,247,245,245,247,245,245,247,245},{245,247,245,245,247,245,245,247,245,245,247,245,245,247,245,245,247,245,245,247,245,245,247,245,245,247,245,245,247,245,245,247},{249,249,251,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246},{248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246},{246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248},{249,249,251,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246},{248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246},{246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248},{249,249,251,245,245,247,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,249,246,246,249,246,246},{249,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248,246},{246,248,246,246,248,246,246,248,246,246,248,246,246,249,246,246,249,246,246,248,246,246,248,246,246,248,246,246,248,246,246,248},{249,249,251,245,245,247,246,246,248,247,246,249,247,246,248,246,246,247,245,246,248,246,246,251,247,245,252,247,245,251,247,245},{250,247,245,250,248,245,249,247,245,248,246,243,247,246,243,247,245,244,248,244,244,248,246,245,248,246,246,248,246,246,248,246},{246,248,246,246,248,246,246,248,246,246,248,246,245,249,246,246,249,245,246,249,245,246,249,246,246,247,246,246,246,246,246,247},{249,249,251,245,245,247,246,246,248,247,246,248,247,246,248,247,246,249,246,246,250,245,246,250,245,246,248,245,246,247,246,246},{247,246,246,247,247,246,247,246,246,247,245,244,245,245,244,245,244,244,247,244,243,247,245,245,248,246,246,248,246,246,248,246},{246,248,246,246,248,246,246,248,246,246,246,246,246,244,246,247,244,246,247,245,245,246,247,246,245,250,246,246,248,246,246,248},{249,249,251,245,245,247,246,246,248,244,245,245,242,243,246,244,243,248,246,244,247,247,247,246,248,250,247,247,249,247,246,247},{248,245,246,248,245,246,251,245,246,251,243,244,249,243,244,248,244,244,244,244,244,244,245,245,247,246,246,248,246,246,248,246},{246,248,246,246,248,246,246,248,246,246,247,246,247,245,246,246,244,247,245,243,249,247,246,246,245,249,246,245,251,246,245,250},{249,249,251,245,245,247,245,245,247,245,248,249,245,248,251,245,245,247,247,246,237,245,243,229,235,233,226,238,236,233,243,240},{241,248,245,249,246,245,253,246,245,253,245,244,252,245,245,251,245,246,243,245,246,241,246,246,246,246,245,249,246,246,249,246},{246,248,246,246,248,246,246,248,245,245,250,244,244,251,248,245,249,247,242,239,240,235,227,242,243,235,245,245,247,246,245,251},{249,249,251,244,244,246,233,233,235,187,192,193,161,166,169,160,161,157,208,207,179,230,227,188,215,210,179,215,209,184,231,224},{205,240,233,220,239,236,226,241,238,229,242,238,230,241,238,229,238,239,229,244,245,238,246,246,245,246,246,250,246,246,249,246},{246,248,247,246,248,247,246,248,245,245,250,246,247,252,240,238,232,222,216,193,202,198,164,206,209,180,241,242,235,246,245,250},{248,248,250,245,245,247,231,231,233,127,131,133,39,44,46,26,27,17,109,109,70,169,167,108,180,174,116,191,183,131,203,194},{147,184,175,133,145,139,102,149,144,106,150,146,108,151,148,114,186,187,169,240,241,234,245,246,245,246,245,250,246,246,251,245}},{{246,250,245,246,249,245,246,249,246,248,248,229,231,219,196,198,164,196,195,140,185,183,121,186,191,148,240,242,229,247,246,250},{249,249,251,244,244,246,244,244,246,233,232,234,174,173,172,114,113,100,112,112,85,112,110,70,112,108,59,125,119,67,151,143},{86,149,139,83,124,113,60,111,103,42,115,111,51,151,148,103,203,204,184,241,243,237,246,247,249,247,247,251,245,247,252,246},{246,251,248,247,249,240,243,241,216,219,204,196,197,157,195,200,138,197,199,132,178,178,118,208,210,176,246,245,244,245,245,250},{249,249,251,244,244,246,244,244,246,246,244,246,249,247,245,239,238,230,222,221,209,199,197,178,124,120,91,82,77,36,132,126},{71,171,164,102,171,162,100,143,137,68,147,143,80,194,191,145,201,204,180,211,214,204,227,229,226,236,238,235,245,243,239,249},{242,236,235,224,212,209,198,177,194,183,153,187,176,134,165,158,106,141,137,80,109,107,52,187,187,159,248,246,251,245,245,249},{248,248,250,244,244,246,244,244,246,245,244,244,242,242,241,243,243,242,250,249,249,253,251,251,189,185,176,91,87,61,96,92},{46,155,152,93,153,150,88,149,147,82,153,151,92,177,175,130,197,200,172,199,203,187,186,190,179,166,169,156,153,152,138,143},{133,117,115,96,73,123,102,69,145,124,86,132,108,74,90,68,36,80,68,26,100,98,47,213,212,190,249,247,251,244,245,248},{247,247,249,244,244,246,244,244,246,244,244,245,244,244,245,244,244,247,242,242,248,243,242,249,244,241,245,179,176,165,104,101},{73,82,80,40,89,90,43,101,102,53,108,107,60,120,118,78,130,134,105,144,149,131,161,165,150,154,159,140,118,124,106,87},{86,70,74,64,42,69,58,29,74,60,27,81,58,27,84,60,28,100,86,48,156,155,114,223,222,207,247,245,250,245,246,246},{247,247,249,244,243,246,244,244,246,243,244,247,242,245,247,242,245,247,242,245,247,243,245,247,244,244,248,241,240,240,219,216},{209,140,138,125,85,88,68,79,81,56,86,85,54,83,81,46,62,65,40,55,60,44,77,81,66,91,96,75,106,113,89,109},{112,90,104,100,78,88,87,63,72,72,45,70,62,26,94,79,29,142,132,87,149,149,121,205,203,195,246,244,250,244,245,244},{246,247,248,243,243,244,244,244,245,242,244,247,241,245,247,241,245,245,241,245,243,241,245,243,242,244,245,244,244,248,252,249},{254,212,210,213,185,186,184,160,161,153,159,159,140,107,107,79,61,64,42,49,53,38,41,45,31,38,42,25,38,41,18,58},{56,29,76,72,43,83,83,52,82,86,58,74,75,37,139,133,71,173,169,114,129,131,104,202,201,197,247,245,250,242,244,243},{245,247,245,242,243,242,242,244,243,242,244,245,242,243,245,242,243,245,242,244,244,242,243,244,242,243,245,242,243,246,242,242},{246,175,175,177,159,160,154,142,143,133,133,135,120,105,108,89,89,96,75,85,93,75,72,78,64,56,63,51,42,45,34,47},{47,26,55,55,18,67,65,21,79,74,38,74,68,30,117,113,58,176,174,122,138,137,108,177,178,176,247,247,250,243,244,245},{245,247,246,242,243,242,242,244,243,242,243,244,242,243,245,242,243,245,242,243,245,242,243,245,242,243,245,242,243,245,243,244},{245,211,213,212,210,215,207,178,181,171,133,134,122,108,107,94,89,97,80,76,88,69,77,89,69,80,91,72,63,69,51,68},{70,46,72,72,40,99,96,65,101,96,59,62,57,8,69,66,21,132,127,103,203,198,196,228,229,231,243,244,246,242,243,245},{245,246,248,241,243,244,242,243,245,242,243,245,242,243,245,242,243,245,242,243,245,242,243,245,242,243,245,242,243,245,241,242},{244,245,248,248,243,252,246,245,249,242,239,237,230,218,212,205,194,193,184,133,135,122,60,62,43,76,80,54,82,85,57,79},{81,55,117,117,97,201,199,188,171,168,147,95,92,54,130,128,99,212,209,204,245,241,252,245,245,248,242,243,245,241,242,244},{244,245,249,241,242,246,241,242,246,241,242,245,242,243,245,241,242,244,241,242,244,241,242,244,241,242,244,241,242,244,241,242},{244,239,242,243,235,244,242,240,244,241,240,238,235,192,184,181,182,170,169,152,140,136,53,42,30,68,57,38,93,90,66,139},{141,122,214,213,207,244,244,245,228,226,225,210,207,200,225,223,215,244,244,240,242,243,243,242,243,245,243,244,246,243,244,246},{243,244,249,241,241,246,241,242,247,241,242,245,241,242,243,241,242,244,241,242,244,241,242,244,241,242,244,241,242,244,241,242}},{{244,241,242,245,241,242,246,242,243,245,243,242,242,221,219,217,214,205,205,196,185,183,100,90,83,121,112,100,188,184,171,234},{232,228,245,245,249,238,242,244,243,245,248,248,245,253,244,243,247,240,243,241,240,244,239,242,243,244,242,243,245,242,243,245},{243,244,250,240,241,247,240,242,247,240,241,246,240,241,245,240,242,245,241,242,245,241,242,245,241,242,245,241,242,245,241,242},{245,241,242,245,242,241,247,242,241,246,242,243,245,246,247,248,248,248,248,246,245,244,209,209,207,225,225,221,247,246,244,244},{242,247,240,240,248,239,243,246,239,242,243,241,240,245,241,241,247,240,243,247,239,243,245,241,242,245,241,242,245,241,242,245},{241,244,251,238,241,247,238,241,248,238,241,248,239,241,248,239,241,248,239,242,248,239,241,247,240,241,246,240,241,246,241,242},{246,241,241,246,240,241,246,240,241,246,241,242,246,240,241,245,239,240,245,240,241,245,242,243,247,241,243,246,240,240,245,240},{240,246,241,241,247,240,241,246,240,242,246,241,242,246,241,242,247,241,242,247,241,242,247,241,242,247,241,242,247,241,242,247},{240,243,250,237,240,247,238,241,248,238,241,248,237,240,247,237,240,247,237,240,247,238,241,247,240,241,246,240,241,246,239,240},{245,239,240,245,240,241,246,240,241,246,239,240,245,239,241,246,240,241,246,240,241,247,239,240,245,240,241,246,241,242,247,240},{241,246,240,241,246,240,241,246,240,241,246,240,241,246,240,241,246,241,242,247,241,242,247,241,242,247,241,242,247,241,242,247},{239,242,249,237,240,247,238,240,247,237,240,247,236,239,246,236,239,246,236,239,246,237,240,246,238,241,246,237,241,245,237,240},{244,237,240,245,238,241,246,238,241,246,237,240,245,237,240,245,238,241,245,238,241,246,238,241,246,238,241,246,238,241,246,238},{241,246,238,241,246,238,241,246,238,241,246,238,241,245,238,241,246,239,242,247,239,242,247,239,242,247,239,242,247,239,242,247},{239,242,249,236,239,246,236,239,246,237,240,247,237,240,247,236,239,246,236,239,246,236,240,246,235,241,245,235,241,245,235,241},{245,235,241,245,235,241,245,235,241,245,235,241,245,235,241,245,235,241,245,235,241,245,235,241,245,234,241,244,235,241,245,235},{242,245,236,242,246,236,242,246,235,242,245,234,240,244,235,241,245,236,242,246,236,242,246,236,242,246,236,242,246,236,242,246},{239,242,249,236,239,245,236,239,246,236,239,246,236,239,246,236,239,246,236,239,246,235,240,245,233,241,244,233,241,244,233,241},{244,233,241,244,233,241,244,233,241,244,233,241,244,233,241,244,233,241,244,233,241,244,233,241,244,233,241,244,233,241,244,233},{241,244,234,242,245,235,243,246,234,242,245,233,241,244,234,242,245,235,243,246,235,243,246,235,243,246,235,243,246,235,243,246},{237,242,249,234,239,246,235,239,246,234,239,246,234,238,246,235,239,246,235,239,246,234,239,246,232,240,245,232,240,244,232,240},{244,232,240,244,232,240,244,232,240,244,232,240,244,232,240,244,232,240,244,232,240,245,233,240,245,233,241,245,233,240,245,232},{240,245,233,241,246,234,242,247,234,241,246,233,240,245,233,241,245,234,242,246,234,242,246,234,242,247,234,242,247,234,242,247},{235,242,250,232,238,246,232,239,247,232,239,247,232,239,247,232,239,247,232,239,247,232,239,247,232,239,247,232,239,247,232,239},{247,232,239,247,232,239,247,232,239,247,232,239,247,232,239,247,232,239,247,232,239,247,233,240,247,233,240,248,233,240,247,233},{240,247,233,240,248,233,240,248,233,240,247,232,239,247,232,239,247,232,239,247,232,239,247,233,240,248,233,240,248,233,240,248},{235,242,250,231,239,246,232,239,247,232,239,247,232,239,247,232,239,247,232,239,247,232,239,247,232,239,247,232,239,247,232,239},{247,232,239,247,232,239,247,232,239,247,232,239,247,232,239,247,232,239,247,232,239,247,232,239,247,232,239,247,232,239,247,232},{239,247,232,239,247,232,239,247,232,239,247,232,239,247,232,239,247,232,239,247,232,239,247,232,239,247,232,239,247,233,240,248},{235,242,250,232,238,246,232,239,247,232,239,247,232,239,247,232,239,247,232,239,247,232,239,247,232,239,247,232,239,247,232,239},{247,232,239,247,232,239,247,232,239,247,232,239,247,232,239,247,232,239,247,232,239,247,232,239,247,231,238,246,231,238,246,231},{238,246,231,238,246,231,238,246,232,239,247,232,239,247,232,239,247,232,239,247,232,239,247,231,238,246,232,239,246,232,239,247}}}
\.

DROP TABLE IF EXISTS cifar_10_sample_test_shape_batched;
DROP TABLE IF EXISTS cifar_10_sample_test_shape_batched_summary;
SELECT training_preprocessor_dl('cifar_10_sample_test_shape','cifar_10_sample_test_shape_batched','y','x', NULL, 255, 3);
